name: licenx-dev-release

on:
  workflow_dispatch:
    inputs:
      licenx-environment:
        description: CMake environment passed to the LicenX generator
        default: dev
        required: false
      licenx-branch:
        description: LicenX submodule branch or ref to build
        default: main
        required: false
      dockerfile-relative-path:
        description: Optional Dockerfile path relative to repository root
        default: ergox/licenx/docker/admin-cli-server/Dockerfile
        required: false
      docker-image-tag:
        description: Container tag to publish alongside latest
        default: latest
        required: false

permissions:
  contents: read
  id-token: write
  packages: write

env:
  LICENX_SUBMODULE_PATH: ergox/licenx
  LICENX_SOURCE_DIR: ergox/licenx
  LICENX_BUILD_DIR: ergox/licenx/build
  LICENX_BUILD_CONFIG: Release
  LICENX_ARTIFACT_ROOT: ergox/licenx/artifacts
  LICENX_ENVIRONMENT_INPUT: ${{ github.event.inputs.licenx-environment || 'dev' }}

jobs:
  build-linux:
    name: Build + Test (Linux)
    runs-on: ubuntu-latest
    env:
      CMAKE_GENERATOR: Ninja
      CMAKE_BUILD_TYPE: Release
      CMAKE_MULTICONFIG: 'false'
      ARTIFACT_PLATFORM_SUFFIX: linux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Prepare LicenX workspace
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $moduleDir = [System.IO.Path]::Combine($Env:GITHUB_WORKSPACE, '.git/modules', $Env:LICENX_SUBMODULE_PATH)
          if (Test-Path $moduleDir) {
            Remove-Item $moduleDir -Recurse -Force
          }
          if (Test-Path $Env:LICENX_SUBMODULE_PATH) {
            Remove-Item $Env:LICENX_SUBMODULE_PATH -Recurse -Force
          }

      - name: Checkout LicenX source
        uses: actions/checkout@v4
        with:
          repository: ergosumx/licenx
          ref: ${{ github.event.inputs.licenx-branch || 'main' }}
          path: ${{ env.LICENX_SUBMODULE_PATH }}
          fetch-depth: 0
          token: ${{ secrets.ERGOX_SUBMODULE_TOKEN }}

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ninja-build pkg-config libssl-dev zlib1g-dev

      - name: Build third-party dependencies
        shell: bash
        run: |
          set -euo pipefail
          deps_root="$GITHUB_WORKSPACE/_deps/linux"
          install_dir="$deps_root/install"
          rm -rf "$deps_root"
          mkdir -p "$deps_root/src/curl" "$deps_root/src/libsodium" "$install_dir"

          curl_tag="curl-8_17_0"
          curl_archive="$deps_root/src/${curl_tag}.tar.gz"
          curl_src="$deps_root/src/curl"
          curl_url="https://github.com/curl/curl/archive/refs/tags/${curl_tag}.tar.gz"
          curl_configure_args=(
            -DCMAKE_BUILD_TYPE=Release
            -DBUILD_SHARED_LIBS=ON
            -DCMAKE_INSTALL_PREFIX="$install_dir"
            -DCURL_USE_OPENSSL=ON
            -DCURL_USE_LIBSSH2=OFF
            -DCURL_ENABLE_SSL=ON
            -DCURL_USE_SCHANNEL=OFF
          )

          libsodium_tag="1.0.20"
          libsodium_archive="$deps_root/src/libsodium-${libsodium_tag}.tar.gz"
          libsodium_src="$deps_root/src/libsodium"
          libsodium_url="https://github.com/jedisct1/libsodium/archive/refs/tags/${libsodium_tag}.tar.gz"

          curl --fail --location --output "$curl_archive" "$curl_url"
          tar -xzf "$curl_archive" --strip-components=1 -C "$curl_src"

          curl --fail --location --output "$libsodium_archive" "$libsodium_url"
          tar -xzf "$libsodium_archive" --strip-components=1 -C "$libsodium_src"

          cmake -G Ninja -S "$curl_src" -B "$deps_root/build/curl" "${curl_configure_args[@]}"
          cmake --build "$deps_root/build/curl" --target install --parallel

          cmake -G Ninja -S "$libsodium_src" -B "$deps_root/build/libsodium" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_INSTALL_PREFIX="$install_dir"
          cmake --build "$deps_root/build/libsodium" --target install --parallel

          echo "CMAKE_PREFIX_PATH=$install_dir${CMAKE_PREFIX_PATH:+:$CMAKE_PREFIX_PATH}" >> "$GITHUB_ENV"
          if [ -d "$install_dir/lib/pkgconfig" ]; then
            echo "PKG_CONFIG_PATH=$install_dir/lib/pkgconfig${PKG_CONFIG_PATH:+:$PKG_CONFIG_PATH}" >> "$GITHUB_ENV"
          fi
          echo "LD_LIBRARY_PATH=$install_dir/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}" >> "$GITHUB_ENV"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Configure LicenX build
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $cmakeArgs = @(
            '-S', $Env:LICENX_SOURCE_DIR,
            '-B', $Env:LICENX_BUILD_DIR,
            '-G', $Env:CMAKE_GENERATOR,
            "-DLICENX_ENVIRONMENT=$Env:LICENX_ENVIRONMENT_INPUT",
            '-DLICENX_BUILD_TESTS=ON'
          )
          if ($Env:CMAKE_MULTICONFIG -ne 'true') {
            $cmakeArgs += "-DCMAKE_BUILD_TYPE=$Env:CMAKE_BUILD_TYPE"
          }
          if ($Env:CMAKE_GENERATOR_PLATFORM) {
            $cmakeArgs += '-A'
            $cmakeArgs += $Env:CMAKE_GENERATOR_PLATFORM
          }
          if ($Env:CMAKE_TOOLCHAIN_FILE) {
            $cmakeArgs += "-DCMAKE_TOOLCHAIN_FILE=$Env:CMAKE_TOOLCHAIN_FILE"
          }
          if ($Env:CMAKE_PREFIX_PATH) {
            $cmakeArgs += "-DCMAKE_PREFIX_PATH=$Env:CMAKE_PREFIX_PATH"
          }
          cmake @cmakeArgs

      - name: Build LicenX artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $args = @('--build', $Env:LICENX_BUILD_DIR)
          if ($multiConfig) { $args += @('--config', $Env:LICENX_BUILD_CONFIG) }
          cmake @args

      - name: Run unit tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $ctestArgs = @('--test-dir', $Env:LICENX_BUILD_DIR, '--output-on-failure')
          if ($multiConfig) { $ctestArgs += @('--config', $Env:LICENX_BUILD_CONFIG) }
          ctest @ctestArgs

      - name: Package release artifacts
        id: package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $workspace = $Env:GITHUB_WORKSPACE
          $buildDir = Join-Path $workspace $Env:LICENX_BUILD_DIR
          $artifactsRoot = Join-Path $workspace $Env:LICENX_ARTIFACT_ROOT
          $publishDir = Join-Path $artifactsRoot 'publish'
          $cliDir = Join-Path $artifactsRoot 'admin-cli'
          $sdkDir = Join-Path $artifactsRoot 'sdk'
          $sdkLibDir = Join-Path $sdkDir 'lib'
          $sdkIncludeDir = Join-Path $sdkDir 'include'

          foreach ($dir in @($artifactsRoot, $publishDir, $cliDir, $sdkDir, $sdkLibDir, $sdkIncludeDir)) {
            if (-not (Test-Path $dir)) {
              New-Item -ItemType Directory -Path $dir | Out-Null
            }
          }

          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $outputDir = if ($multiConfig) { Join-Path $buildDir $Env:LICENX_BUILD_CONFIG } else { $buildDir }

          $cliCandidates = @(
            Join-Path $outputDir 'licenx_admin_cli.exe',
            Join-Path $outputDir 'licenx_admin_cli',
            Join-Path $buildDir 'licenx_admin_cli.exe',
            Join-Path $buildDir 'licenx_admin_cli'
          )

          $cliPath = $null
          foreach ($candidate in $cliCandidates) {
            if (Test-Path $candidate) {
              $cliPath = $candidate
              break
            }
          }

          if (-not $cliPath) {
            throw "Expected CLI artifact not found. Checked: $($cliCandidates -join ', ')"
          }

          Copy-Item $cliPath $cliDir -Force

          $libraryPatterns = @('licenx*.lib','licenx*.dll','licenx*.exp','licenx*.pdb','liblicenx*.a','liblicenx*.so','liblicenx*.dylib')
          $libraries = @()
          foreach ($pattern in $libraryPatterns) {
            $libraries += Get-ChildItem -Path $outputDir -Recurse -File -Filter $pattern -ErrorAction SilentlyContinue
          }
          $libraries = $libraries | Sort-Object -Property FullName -Unique
          if ($libraries.Count -eq 0) {
            throw "No LicenX library artifacts matching expected patterns were found in $outputDir"
          }
          foreach ($lib in $libraries) {
            Copy-Item $lib.FullName $sdkLibDir -Force
          }

          $includeSource = Join-Path $workspace (Join-Path $Env:LICENX_SOURCE_DIR 'include')
          if (-not (Test-Path $includeSource)) {
            throw "Header directory not found at $includeSource"
          }
          Copy-Item (Join-Path $includeSource '*') $sdkIncludeDir -Recurse -Force

          $readmeSource = Join-Path $workspace (Join-Path $Env:LICENX_SOURCE_DIR 'README.md')
          if (Test-Path $readmeSource) {
            Copy-Item $readmeSource $sdkDir -Force
          }

          $platform = $Env:ARTIFACT_PLATFORM_SUFFIX
          $cliZip = Join-Path $publishDir "licenx-admin-cli-$platform.zip"
          $sdkZip = Join-Path $publishDir "licenx-sdk-$platform.zip"

          if (Test-Path $cliZip) { Remove-Item $cliZip -Force }
          if (Test-Path $sdkZip) { Remove-Item $sdkZip -Force }

          Compress-Archive -Path (Join-Path $cliDir '*') -DestinationPath $cliZip -Force
          Compress-Archive -Path (Join-Path $sdkDir '*') -DestinationPath $sdkZip -Force

          "publish-dir=$publishDir" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: licenx-linux
          path: ${{ steps.package.outputs.publish-dir }}
          if-no-files-found: error

  build-macos:
    name: Build + Test (macOS)
    runs-on: macos-latest
    env:
      CMAKE_GENERATOR: Ninja
      CMAKE_BUILD_TYPE: Release
      CMAKE_MULTICONFIG: 'false'
      ARTIFACT_PLATFORM_SUFFIX: macos
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Prepare LicenX workspace
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $moduleDir = [System.IO.Path]::Combine($Env:GITHUB_WORKSPACE, '.git/modules', $Env:LICENX_SUBMODULE_PATH)
          if (Test-Path $moduleDir) {
            Remove-Item $moduleDir -Recurse -Force
          }
          if (Test-Path $Env:LICENX_SUBMODULE_PATH) {
            Remove-Item $Env:LICENX_SUBMODULE_PATH -Recurse -Force
          }

      - name: Checkout LicenX source
        uses: actions/checkout@v4
        with:
          repository: ergosumx/licenx
          ref: ${{ github.event.inputs.licenx-branch || 'main' }}
          path: ${{ env.LICENX_SUBMODULE_PATH }}
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.ERGOX_SUBMODULE_TOKEN }}

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          brew update
          if ! brew list ninja >/dev/null 2>&1; then
            brew install ninja
          fi
          if ! brew list pkg-config >/dev/null 2>&1; then
            brew install pkg-config
          fi
          if ! brew list openssl@3 >/dev/null 2>&1; then
            brew install openssl@3
          fi

      - name: Build third-party dependencies
        shell: bash
        run: |
          set -euo pipefail
          deps_root="$GITHUB_WORKSPACE/_deps/macos"
          install_dir="$deps_root/install"
          rm -rf "$deps_root"
          mkdir -p "$deps_root/src/curl" "$deps_root/src/libsodium" "$install_dir"

          curl_tag="curl-8_17_0"
          curl_archive="$deps_root/src/${curl_tag}.tar.gz"
          curl_src="$deps_root/src/curl"
          curl_url="https://github.com/curl/curl/archive/refs/tags/${curl_tag}.tar.gz"

          libsodium_tag="1.0.20"
          libsodium_archive="$deps_root/src/libsodium-${libsodium_tag}.tar.gz"
          libsodium_src="$deps_root/src/libsodium"
          libsodium_url="https://github.com/jedisct1/libsodium/archive/refs/tags/${libsodium_tag}.tar.gz"

          curl --fail --location --output "$curl_archive" "$curl_url"
          tar -xzf "$curl_archive" --strip-components=1 -C "$curl_src"

          curl --fail --location --output "$libsodium_archive" "$libsodium_url"
          tar -xzf "$libsodium_archive" --strip-components=1 -C "$libsodium_src"

          openssl_prefix="$(brew --prefix openssl@3)"

          cmake -G Ninja -S "$curl_src" -B "$deps_root/build/curl" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_INSTALL_PREFIX="$install_dir" \
            -DCURL_USE_OPENSSL=ON \
            -DOPENSSL_ROOT_DIR="$openssl_prefix" \
            -DCURL_USE_LIBSSH2=OFF \
            -DCURL_USE_SCHANNEL=OFF
          cmake --build "$deps_root/build/curl" --target install --parallel

          cmake -G Ninja -S "$libsodium_src" -B "$deps_root/build/libsodium" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_INSTALL_PREFIX="$install_dir"
          cmake --build "$deps_root/build/libsodium" --target install --parallel

          echo "CMAKE_PREFIX_PATH=$install_dir${CMAKE_PREFIX_PATH:+:$CMAKE_PREFIX_PATH}" >> "$GITHUB_ENV"
          if [ -d "$install_dir/lib/pkgconfig" ]; then
            echo "PKG_CONFIG_PATH=$install_dir/lib/pkgconfig${PKG_CONFIG_PATH:+:$PKG_CONFIG_PATH}" >> "$GITHUB_ENV"
          fi
          if [ -d "$install_dir/lib" ]; then
            echo "DYLD_LIBRARY_PATH=$install_dir/lib${DYLD_LIBRARY_PATH:+:$DYLD_LIBRARY_PATH}" >> "$GITHUB_ENV"
          fi

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Configure LicenX build
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $cmakeArgs = @(
            '-S', $Env:LICENX_SOURCE_DIR,
            '-B', $Env:LICENX_BUILD_DIR,
            '-G', $Env:CMAKE_GENERATOR,
            "-DLICENX_ENVIRONMENT=$Env:LICENX_ENVIRONMENT_INPUT",
            '-DLICENX_BUILD_TESTS=ON'
          )
          if ($Env:CMAKE_MULTICONFIG -ne 'true') {
            $cmakeArgs += "-DCMAKE_BUILD_TYPE=$Env:CMAKE_BUILD_TYPE"
          }
          if ($Env:CMAKE_GENERATOR_PLATFORM) {
            $cmakeArgs += '-A'
            $cmakeArgs += $Env:CMAKE_GENERATOR_PLATFORM
          }
          if ($Env:CMAKE_TOOLCHAIN_FILE) {
            $cmakeArgs += "-DCMAKE_TOOLCHAIN_FILE=$Env:CMAKE_TOOLCHAIN_FILE"
          }
          if ($Env:CMAKE_PREFIX_PATH) {
            $cmakeArgs += "-DCMAKE_PREFIX_PATH=$Env:CMAKE_PREFIX_PATH"
          }
          cmake @cmakeArgs

      - name: Build LicenX artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $args = @('--build', $Env:LICENX_BUILD_DIR)
          if ($multiConfig) { $args += @('--config', $Env:LICENX_BUILD_CONFIG) }
          cmake @args

      - name: Run unit tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $ctestArgs = @('--test-dir', $Env:LICENX_BUILD_DIR, '--output-on-failure')
          if ($multiConfig) { $ctestArgs += @('--config', $Env:LICENX_BUILD_CONFIG) }
          ctest @ctestArgs

      - name: Package release artifacts
        id: package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $workspace = $Env:GITHUB_WORKSPACE
          $buildDir = Join-Path $workspace $Env:LICENX_BUILD_DIR
          $artifactsRoot = Join-Path $workspace $Env:LICENX_ARTIFACT_ROOT
          $publishDir = Join-Path $artifactsRoot 'publish'
          $cliDir = Join-Path $artifactsRoot 'admin-cli'
          $sdkDir = Join-Path $artifactsRoot 'sdk'
          $sdkLibDir = Join-Path $sdkDir 'lib'
          $sdkIncludeDir = Join-Path $sdkDir 'include'

          foreach ($dir in @($artifactsRoot, $publishDir, $cliDir, $sdkDir, $sdkLibDir, $sdkIncludeDir)) {
            if (-not (Test-Path $dir)) {
              New-Item -ItemType Directory -Path $dir | Out-Null
            }
          }

          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $outputDir = if ($multiConfig) { Join-Path $buildDir $Env:LICENX_BUILD_CONFIG } else { $buildDir }

          $cliCandidates = @(
            Join-Path $outputDir 'licenx_admin_cli.exe',
            Join-Path $outputDir 'licenx_admin_cli',
            Join-Path $buildDir 'licenx_admin_cli.exe',
            Join-Path $buildDir 'licenx_admin_cli'
          )

          $cliPath = $null
          foreach ($candidate in $cliCandidates) {
            if (Test-Path $candidate) {
              $cliPath = $candidate
              break
            }
          }

          if (-not $cliPath) {
            throw "Expected CLI artifact not found. Checked: $($cliCandidates -join ', ')"
          }

          Copy-Item $cliPath $cliDir -Force

          $libraryPatterns = @('licenx*.lib','licenx*.dll','licenx*.exp','licenx*.pdb','liblicenx*.a','liblicenx*.so','liblicenx*.dylib')
          $libraries = @()
          foreach ($pattern in $libraryPatterns) {
            $libraries += Get-ChildItem -Path $outputDir -Recurse -File -Filter $pattern -ErrorAction SilentlyContinue
          }
          $libraries = $libraries | Sort-Object -Property FullName -Unique
          if ($libraries.Count -eq 0) {
            throw "No LicenX library artifacts matching expected patterns were found in $outputDir"
          }
          foreach ($lib in $libraries) {
            Copy-Item $lib.FullName $sdkLibDir -Force
          }

          $includeSource = Join-Path $workspace (Join-Path $Env:LICENX_SOURCE_DIR 'include')
          if (-not (Test-Path $includeSource)) {
            throw "Header directory not found at $includeSource"
          }
          Copy-Item (Join-Path $includeSource '*') $sdkIncludeDir -Recurse -Force

          $readmeSource = Join-Path $workspace (Join-Path $Env:LICENX_SOURCE_DIR 'README.md')
          if (Test-Path $readmeSource) {
            Copy-Item $readmeSource $sdkDir -Force
          }

          $platform = $Env:ARTIFACT_PLATFORM_SUFFIX
          $cliZip = Join-Path $publishDir "licenx-admin-cli-$platform.zip"
          $sdkZip = Join-Path $publishDir "licenx-sdk-$platform.zip"

          if (Test-Path $cliZip) { Remove-Item $cliZip -Force }
          if (Test-Path $sdkZip) { Remove-Item $sdkZip -Force }

          Compress-Archive -Path (Join-Path $cliDir '*') -DestinationPath $cliZip -Force
          Compress-Archive -Path (Join-Path $sdkDir '*') -DestinationPath $sdkZip -Force

          "publish-dir=$publishDir" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: licenx-macos
          path: ${{ steps.package.outputs.publish-dir }}
          if-no-files-found: error

  build-windows:
    name: Build + Test (Windows)
    runs-on: windows-latest
    env:
      CMAKE_GENERATOR: "Visual Studio 17 2022"
      CMAKE_GENERATOR_PLATFORM: x64
      CMAKE_BUILD_TYPE: Release
      CMAKE_MULTICONFIG: 'true'
      ARTIFACT_PLATFORM_SUFFIX: windows
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Prepare LicenX workspace
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $moduleDir = [System.IO.Path]::Combine($Env:GITHUB_WORKSPACE, '.git/modules', $Env:LICENX_SUBMODULE_PATH)
          if (Test-Path $moduleDir) {
            Remove-Item $moduleDir -Recurse -Force
          }
          if (Test-Path $Env:LICENX_SUBMODULE_PATH) {
            Remove-Item $Env:LICENX_SUBMODULE_PATH -Recurse -Force
          }

      - name: Checkout LicenX source
        uses: actions/checkout@v4
        with:
          repository: ergosumx/licenx
          ref: ${{ github.event.inputs.licenx-branch || 'main' }}
          path: ${{ env.LICENX_SUBMODULE_PATH }}
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.ERGOX_SUBMODULE_TOKEN }}

      - name: Install build prerequisites
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          choco install ninja --no-progress --yes

      - name: Build third-party dependencies
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $depsRoot = [System.IO.Path]::Combine($Env:GITHUB_WORKSPACE, '_deps', 'windows')
          $installDir = [System.IO.Path]::Combine($depsRoot, 'install')
          if (Test-Path $depsRoot) {
            Remove-Item $depsRoot -Recurse -Force
          }
          New-Item -ItemType Directory -Path $depsRoot | Out-Null
          $srcRoot = [System.IO.Path]::Combine($depsRoot, 'src')
          New-Item -ItemType Directory -Path $srcRoot | Out-Null
          $curlSrc = [System.IO.Path]::Combine($srcRoot, 'curl')
          $libsodiumSrc = [System.IO.Path]::Combine($srcRoot, 'libsodium')
          New-Item -ItemType Directory -Path $curlSrc | Out-Null
          New-Item -ItemType Directory -Path $libsodiumSrc | Out-Null
          New-Item -ItemType Directory -Path $installDir | Out-Null

          $curlTag = 'curl-8_17_0'
          $curlArchive = [System.IO.Path]::Combine($srcRoot, "$curlTag.tar.gz")
          $curlUrl = "https://github.com/curl/curl/archive/refs/tags/$curlTag.tar.gz"

          $libsodiumTag = '1.0.20'
          $libsodiumArchive = [System.IO.Path]::Combine($srcRoot, "libsodium-$libsodiumTag.tar.gz")
          $libsodiumUrl = "https://github.com/jedisct1/libsodium/archive/refs/tags/$libsodiumTag.tar.gz"

          Invoke-WebRequest -Uri $curlUrl -OutFile $curlArchive -UseBasicParsing
          tar -xzf $curlArchive --strip-components=1 -C $curlSrc

          Invoke-WebRequest -Uri $libsodiumUrl -OutFile $libsodiumArchive -UseBasicParsing
          tar -xzf $libsodiumArchive --strip-components=1 -C $libsodiumSrc

          $generatorArgs = @()
          if ($Env:CMAKE_GENERATOR) { $generatorArgs += @('-G', $Env:CMAKE_GENERATOR) }
          if ($Env:CMAKE_GENERATOR_PLATFORM) { $generatorArgs += @('-A', $Env:CMAKE_GENERATOR_PLATFORM) }

          $buildRoot = [System.IO.Path]::Combine($depsRoot, 'build')
          New-Item -ItemType Directory -Path $buildRoot | Out-Null
          $curlBuild = [System.IO.Path]::Combine($buildRoot, 'curl')
          $libsodiumBuild = [System.IO.Path]::Combine($buildRoot, 'libsodium')

          cmake @generatorArgs -S $curlSrc -B $curlBuild -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX=$installDir -DCURL_USE_SCHANNEL=ON -DCURL_USE_OPENSSL=OFF -DCURL_USE_LIBSSH2=OFF
          cmake --build $curlBuild --target install --config Release

          cmake @generatorArgs -S $libsodiumSrc -B $libsodiumBuild -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX=$installDir
          cmake --build $libsodiumBuild --target install --config Release

          $existingPrefix = $Env:CMAKE_PREFIX_PATH
          $prefixValue = if ([string]::IsNullOrWhiteSpace($existingPrefix)) { $installDir } else { "$installDir;$existingPrefix" }
          "CMAKE_PREFIX_PATH=$prefixValue" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

          $binPath = [System.IO.Path]::Combine($installDir, 'bin')
          if (Test-Path $binPath) {
            $existingPath = $Env:PATH
            $pathValue = if ([string]::IsNullOrWhiteSpace($existingPath)) { $binPath } else { "$binPath;$existingPath" }
            "PATH=$pathValue" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          }

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Configure LicenX build
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $cmakeArgs = @(
            '-S', $Env:LICENX_SOURCE_DIR,
            '-B', $Env:LICENX_BUILD_DIR,
            '-G', $Env:CMAKE_GENERATOR,
            "-DLICENX_ENVIRONMENT=$Env:LICENX_ENVIRONMENT_INPUT",
            '-DLICENX_BUILD_TESTS=ON'
          )
          if ($Env:CMAKE_MULTICONFIG -ne 'true') {
            $cmakeArgs += "-DCMAKE_BUILD_TYPE=$Env:CMAKE_BUILD_TYPE"
          }
          if ($Env:CMAKE_GENERATOR_PLATFORM) {
            $cmakeArgs += '-A'
            $cmakeArgs += $Env:CMAKE_GENERATOR_PLATFORM
          }
          if ($Env:CMAKE_TOOLCHAIN_FILE) {
            $cmakeArgs += "-DCMAKE_TOOLCHAIN_FILE=$Env:CMAKE_TOOLCHAIN_FILE"
          }
          if ($Env:CMAKE_PREFIX_PATH) {
            $cmakeArgs += "-DCMAKE_PREFIX_PATH=$Env:CMAKE_PREFIX_PATH"
          }
          cmake @cmakeArgs

      - name: Build LicenX artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $args = @('--build', $Env:LICENX_BUILD_DIR)
          if ($multiConfig) { $args += @('--config', $Env:LICENX_BUILD_CONFIG) }
          cmake @args

      - name: Run unit tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $ctestArgs = @('--test-dir', $Env:LICENX_BUILD_DIR, '--output-on-failure')
          if ($multiConfig) { $ctestArgs += @('--config', $Env:LICENX_BUILD_CONFIG) }
          ctest @ctestArgs

      - name: Package release artifacts
        id: package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $workspace = $Env:GITHUB_WORKSPACE
          $buildDir = Join-Path $workspace $Env:LICENX_BUILD_DIR
          $artifactsRoot = Join-Path $workspace $Env:LICENX_ARTIFACT_ROOT
          $publishDir = Join-Path $artifactsRoot 'publish'
          $cliDir = Join-Path $artifactsRoot 'admin-cli'
          $sdkDir = Join-Path $artifactsRoot 'sdk'
          $sdkLibDir = Join-Path $sdkDir 'lib'
          $sdkIncludeDir = Join-Path $sdkDir 'include'

          foreach ($dir in @($artifactsRoot, $publishDir, $cliDir, $sdkDir, $sdkLibDir, $sdkIncludeDir)) {
            if (-not (Test-Path $dir)) {
              New-Item -ItemType Directory -Path $dir | Out-Null
            }
          }

          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $outputDir = if ($multiConfig) { Join-Path $buildDir $Env:LICENX_BUILD_CONFIG } else { $buildDir }

          $cliCandidates = @(
            Join-Path $outputDir 'licenx_admin_cli.exe',
            Join-Path $outputDir 'licenx_admin_cli',
            Join-Path $buildDir 'licenx_admin_cli.exe',
            Join-Path $buildDir 'licenx_admin_cli'
          )

          $cliPath = $null
          foreach ($candidate in $cliCandidates) {
            if (Test-Path $candidate) {
              $cliPath = $candidate
              break
            }
          }

          if (-not $cliPath) {
            throw "Expected CLI artifact not found. Checked: $($cliCandidates -join ', ')"
          }

          Copy-Item $cliPath $cliDir -Force

          $libraryPatterns = @('licenx*.lib','licenx*.dll','licenx*.exp','licenx*.pdb','liblicenx*.a','liblicenx*.so','liblicenx*.dylib')
          $libraries = @()
          foreach ($pattern in $libraryPatterns) {
            $libraries += Get-ChildItem -Path $outputDir -Recurse -File -Filter $pattern -ErrorAction SilentlyContinue
          }
          $libraries = $libraries | Sort-Object -Property FullName -Unique
          if ($libraries.Count -eq 0) {
            throw "No LicenX library artifacts matching expected patterns were found in $outputDir"
          }
          foreach ($lib in $libraries) {
            Copy-Item $lib.FullName $sdkLibDir -Force
          }

          $includeSource = Join-Path $workspace (Join-Path $Env:LICENX_SOURCE_DIR 'include')
          if (-not (Test-Path $includeSource)) {
            throw "Header directory not found at $includeSource"
          }
          Copy-Item (Join-Path $includeSource '*') $sdkIncludeDir -Recurse -Force

          $readmeSource = Join-Path $workspace (Join-Path $Env:LICENX_SOURCE_DIR 'README.md')
          if (Test-Path $readmeSource) {
            Copy-Item $readmeSource $sdkDir -Force
          }

          $platform = $Env:ARTIFACT_PLATFORM_SUFFIX
          $cliZip = Join-Path $publishDir "licenx-admin-cli-$platform.zip"
          $sdkZip = Join-Path $publishDir "licenx-sdk-$platform.zip"

          if (Test-Path $cliZip) { Remove-Item $cliZip -Force }
          if (Test-Path $sdkZip) { Remove-Item $sdkZip -Force }

          Compress-Archive -Path (Join-Path $cliDir '*') -DestinationPath $cliZip -Force
          Compress-Archive -Path (Join-Path $sdkDir '*') -DestinationPath $sdkZip -Force

          "publish-dir=$publishDir" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: licenx-windows
          path: ${{ steps.package.outputs.publish-dir }}
          if-no-files-found: error

  publish-and-docker:
    name: Publish artifacts & Docker image
    needs:
      - build-linux
      - build-macos
      - build-windows
    runs-on: ubuntu-latest
    env:
      CMAKE_GENERATOR: Ninja
      CMAKE_BUILD_TYPE: Release
      CMAKE_MULTICONFIG: 'false'
      ARTIFACT_PLATFORM_SUFFIX: linux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Prepare LicenX workspace
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $moduleDir = [System.IO.Path]::Combine($Env:GITHUB_WORKSPACE, '.git/modules', $Env:LICENX_SUBMODULE_PATH)
          if (Test-Path $moduleDir) {
            Remove-Item $moduleDir -Recurse -Force
          }
          if (Test-Path $Env:LICENX_SUBMODULE_PATH) {
            Remove-Item $Env:LICENX_SUBMODULE_PATH -Recurse -Force
          }

      - name: Checkout LicenX source
        uses: actions/checkout@v4
        with:
          repository: ergosumx/licenx
          ref: ${{ github.event.inputs.licenx-branch || 'main' }}
          path: ${{ env.LICENX_SUBMODULE_PATH }}
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.ERGOX_SUBMODULE_TOKEN }}

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ninja-build libcurl4-openssl-dev

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Configure LicenX build (container stage)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $cmakeArgs = @(
            '-S', $Env:LICENX_SOURCE_DIR,
            '-B', $Env:LICENX_BUILD_DIR,
            '-G', $Env:CMAKE_GENERATOR,
            "-DLICENX_ENVIRONMENT=$Env:LICENX_ENVIRONMENT_INPUT",
            '-DLICENX_BUILD_TESTS=OFF'
          )
          if ($Env:CMAKE_MULTICONFIG -ne 'true') {
            $cmakeArgs += "-DCMAKE_BUILD_TYPE=$Env:CMAKE_BUILD_TYPE"
          }
          if ($Env:CMAKE_GENERATOR_PLATFORM) {
            $cmakeArgs += '-A'
            $cmakeArgs += $Env:CMAKE_GENERATOR_PLATFORM
          }
          if ($Env:CMAKE_TOOLCHAIN_FILE) {
            $cmakeArgs += "-DCMAKE_TOOLCHAIN_FILE=$Env:CMAKE_TOOLCHAIN_FILE"
          }
          if ($Env:CMAKE_PREFIX_PATH) {
            $cmakeArgs += "-DCMAKE_PREFIX_PATH=$Env:CMAKE_PREFIX_PATH"
          }
          cmake @cmakeArgs

      - name: Build LicenX artifacts (container stage)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $multiConfig = $Env:CMAKE_MULTICONFIG -eq 'true'
          $args = @('--build', $Env:LICENX_BUILD_DIR)
          if ($multiConfig) { $args += @('--config', $Env:LICENX_BUILD_CONFIG) }
          cmake @args

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: licenx-windows
          path: collected/windows

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: licenx-linux
          path: collected/linux

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: licenx-macos
          path: collected/macos

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Publish packages to Azure Files
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $source = Join-Path $Env:GITHUB_WORKSPACE 'collected'
          if (-not (Test-Path $source)) {
            throw "Collected artifacts directory $source not found."
          }

          $targets = @(
            @{ Folder = 'windows'; Destination = "$($Env:AZURE_STORAGE_PATH)/windows-x64" },
            @{ Folder = 'linux'; Destination = "$($Env:AZURE_STORAGE_PATH)/linux-x64" },
            @{ Folder = 'macos'; Destination = "$($Env:AZURE_STORAGE_PATH)/macos-universal" }
          )

          foreach ($target in $targets) {
            $platformSource = Join-Path $source $target.Folder
            if (-not (Test-Path $platformSource)) {
              Write-Host "::warning::Platform artifacts not found at $platformSource. Skipping upload to $($target.Destination)."
              continue
            }

            az storage file upload-batch `
              --source $platformSource `
              --account-name $Env:AZURE_STORAGE_ACCOUNT `
              --destination $Env:AZURE_STORAGE_SHARE `
              --destination-path $target.Destination `
              --overwrite `
              --no-progress `
              --auth-mode login
          }

      - name: Build and push LicenX server image
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $dockerfileInput = '${{ github.event.inputs.dockerfile-relative-path || 'ergox/licenx/docker/admin-cli-server/Dockerfile' }}'
          $dockerfile = Join-Path $Env:GITHUB_WORKSPACE $dockerfileInput
          if (-not (Test-Path $dockerfile)) {
            Write-Host "::warning::Dockerfile not found at $dockerfile. Skipping container build."
            return
          }

          $context = Split-Path $dockerfile -Parent
          az acr login --name $Env:ACR_REGISTRY

          $tag = '${{ github.event.inputs.docker-image-tag || 'latest' }}'
          $fullTagLatest = "$Env:ACR_LOGIN_SERVER/$Env:ACR_IMAGE_NAME:latest"
          $fullTagCustom = "$Env:ACR_LOGIN_SERVER/$Env:ACR_IMAGE_NAME:$tag"

          docker build --file $dockerfile --build-arg LICENX_BUILD_DIR=$Env:LICENX_BUILD_DIR --tag $fullTagLatest --tag $fullTagCustom $context
          docker push $fullTagLatest
          if ($tag -ne 'latest') {
            docker push $fullTagCustom
          }
